name: Android Issue Monitor

on:
  issues:
    types: [opened, reopened, labeled]

concurrency:
  group: android-monitor-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  implement:
    if: >-
      contains(github.event.issue.labels.*.name, 'android')
      && (github.event.action != 'labeled' || github.event.label.name == 'android')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Post status comment
        id: comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            **Android Agent** :robot:
            Working on this issue â€” will open a PR when ready...

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code implementation
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are an autonomous Android engineer. Implement GitHub issue #${{ github.event.issue.number }}.

            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}

            Instructions:
            1) Read and understand the full issue.
            2) Explore the codebase to find relevant files.
            3) Implement the changes described in the issue.
            4) Create clear, focused commits with descriptive messages.
            5) If the issue has a task checklist, complete as many tasks as possible.
            6) Do NOT create new markdown documentation files unless the issue explicitly asks for them.
            7) Prefer small, focused changes over large rewrites.

            The Android app is at dmv-android/ using Kotlin, Jetpack Compose, Room, and Coil 3.
          claude_args: "--max-turns 30"

      - name: Update comment with result
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            **Android Agent** ${{ steps.claude.outcome == 'success' && ':white_check_mark:' || ':x:' }}
            Implementation ${{ steps.claude.outcome == 'success' && 'completed' || 'failed' }}.
            [Workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
